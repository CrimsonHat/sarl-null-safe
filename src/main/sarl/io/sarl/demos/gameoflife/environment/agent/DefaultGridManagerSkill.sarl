/**
 *
 */
package io.sarl.demos.gameoflife.environment.^agent

import io.sarl.core.DefaultContextInteractions
import java.util.HashSet
import java.util.List
import java.util.Map
import java.util.Random
import java.util.Set
import java.util.UUID
import org.arakhne.afc.math.MathUtil
import org.arakhne.afc.math.geometry.d2.i.Point2i

/**
 * @author Jérôme BOULMIER
 * @author Maxime PINARD
 */
skill DefaultGridManagerSkill implements GridManager {
	uses DefaultContextInteractions

	val random = new Random
	val width : int
	val height : int

	val grid : List<List<Pair<UUID, Boolean>>> = newArrayList
	val bodies : Map<UUID, AgentBody> = newTreeMap(null)

	new(width : int, height : int) {
		this.width = width
		this.height = height	
	}
	
	def install {
		super.install
		for (i : 0 ..< width) {
			val line = newArrayList
			for (j : 0 ..< height) {
				val uuid = spawn(CellAgent, defaultContext.ID)
				line.add(Pair.of(uuid, true));

				val agentBody = new AgentBody(new Point2i(width, height), line.last.value)
				bodies.put(uuid, agentBody)
			}
			grid.add(line)
		}
		/*for (i : 0 ..< width) {
			val line = newArrayList
			for (j : 0 ..< height) {
				val uuid = spawn(CellAgent, defaultContext.ID)
				if (j == 2) {
					line.add(Pair.of(uuid, true));
				} else {
					line.add(Pair.of(uuid, false));
				}

				val agentBody = new AgentBody(new Point2i(width, height), line.last.value)
				bodies.put(uuid, agentBody)
			}
			grid.add(line)
		}*/
	}

	override getPerceptions : List<Pair<UUID, Set<Point2i>>> {
		val perceptions = <Pair<UUID, Set<Point2i>>>newArrayList();

		for(i : 0..<width){
			for(j : 0..<height){
				val set = new HashSet<Point2i>();
				for(k : MathUtil.max(i - 1, 0) .. MathUtil.min(i + 1, width - 1)){
					for(l : MathUtil.max(j - 1, 0) .. MathUtil.min(j + 1, height - 1)){
						if(k != i && l != j){
							if(grid.get(k).get(l).getValue().equals(Boolean.TRUE)){
								set.add(new Point2i(k - i, l - j));
							}
						}
					}
				}
				perceptions.add(new Pair<UUID, Set<Point2i>>(grid.get(i).get(j).getKey(), set));
			}
		}

		return perceptions;
	}

	override getWidth : int {
		width
	}

	override getHeight : int {
		height
	}

	override applyActions(actions : List<Action>) {
		for (action : actions) {
			grid.get(action.getPosition().ix() - 1).
				set(action.getPosition().iy() - 1,
					Pair.of(grid.get(action.getPosition().ix() - 1).get(action.getPosition().iy() - 1).getKey(),
						action.getType() == Action.Type.CREATE
					))

			bodies.get(action.emitter).alive = (action.getType() == Action.Type.CREATE)
		}
	}

	override isAlive(uuid : UUID) : boolean {
		bodies.get(uuid).alive;
	}

	override getPosition(uuid : UUID) : Point2i {
		bodies.get(uuid).position
	}

	override getGrid : List<List<Pair<UUID, Boolean>>> {
		return grid;
	}
}
